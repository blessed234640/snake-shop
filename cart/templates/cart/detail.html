{% extends "shop/base.html" %} 
{% load i18n static currency_tags %}

{% block title %}
  {% translate "Shopping cart" %} - {% translate "Snake Paradise" %}
{% endblock %} 

{% block content %}
<div class="cart-container">
    <h1>üõí {% translate "Shopping cart" %}</h1>

    {% if cart %}
    <div class="cart">
        <table>
            <thead>
                <tr>
                    <th>{% translate "Image" %}</th>
                    <th>{% translate "Product" %}</th>
                    <th>{% translate "Quantity" %}</th>
                    <th>{% translate "Remove" %}</th>
                    <th>{% translate "Unit price" %}</th>
                    <th>{% translate "Price" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for item in cart %} 
                {% with product=item.product %}
                <tr>
                    <td>
                        <a href="{{ product.get_absolute_url }}">
                            <img
                                src="{% if product.image %}{{ product.image.url }}{% else %}{% static 'shop/img/no_image.png' %}{% endif %}"
                                alt="{{ product.name }}"
                            />
                        </a>
                    </td>
                    <td>
                        <a
                            href="{{ product.get_absolute_url }}"
                            style="color: var(--text-primary); font-weight: 500"
                        >
                            {{ product.name }}
                        </a>
                    </td>
                    <td>
                        <form
                            action="{% url 'cart:cart_add' product.id %}"
                            method="post"
                            class="quantity-form"
                        >
                            {{ item.update_quantity_form.quantity }}
                            <input
                                type="submit"
                                value='{% translate "Update" %}'
                                class="button light"
                                style="padding: 8px 16px"
                            />
                            {% csrf_token %}
                        </form>
                    </td>
                    <td>
                        <form
                            action="{% url 'cart:cart_remove' product.id %}"
                            method="post"
                        >
                            <input
                                type="submit"
                                value='üóë {% translate "Remove" %}'
                                class="button"
                                style="background: #dc3545; padding: 8px 16px"
                            />
                            {% csrf_token %}
                        </form>
                    </td>
                    <td class="num">{{ item.price|currency }}</td>
                    <td class="num">{{ item.total_price|currency }}</td>
                </tr>
                {% endwith %} 
                {% endfor %} 
                
                {% if cart.coupon %}
                <tr class="subtotal">
                    <td>{% translate "Subtotal" %}</td>
                    <td colspan="4"></td>
                    <td class="num">
                        {{ cart.get_total_price|currency }}
                    </td>
                </tr>
                <tr>
                    <td>
                        {% blocktranslate with code=cart.coupon.code discount=cart.coupon.discount %}
                            Coupon "{{ code }}" ({{ discount }}% discount)
                        {% endblocktranslate %}
                    </td>
                    <td colspan="4"></td>
                    <td class="num neg">
                        - {{ cart.get_discount|currency }}
                    </td>
                </tr>
                {% endif %}

                <tr class="total">
                    <td colspan="5"><strong>{% translate "Total" %}</strong></td>
                    <td class="num">
                        <strong>{{ cart.get_total_price_after_discount|currency }}</strong>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- –ë–ª–æ–∫ —Å –∫—É–ø–æ–Ω–æ–º -->
    <div
        class="coupon-section"
        style="
            margin: 2rem 0;
            padding: 1.5rem;
            background: var(--bg-card);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        "
    >
        <h3 style="color: var(--accent-primary); margin-bottom: 1rem">
            {% translate "Apply coupon" %}:
        </h3>
        <form
            action="{% url 'coupons:apply' %}"
            method="post"
            style="display: flex; gap: 1rem; align-items: flex-end"
        >
            {{ coupon_apply_form }}
            <input
                type="submit"
                value='{% translate "Apply" %}'
                class="button light"
                style="padding: 10px 20px"
            />
            {% csrf_token %}
        </form>
    </div>

    <!-- –ë–ª–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π -->
    {% if recommended_products %}
    <div
        class="recommendations-section"
        style="
            margin: 2rem 0;
            padding: 2rem;
            background: var(--bg-card);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        "
    >
        <h3
            style="
                color: var(--accent-primary);
                margin-bottom: 1.5rem;
                text-align: center;
            "
        >
            üêç {% translate "People who bought this also bought" %}
        </h3>
        <div
            class="recommendations-grid"
            style="
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1.5rem;
                margin-top: 1rem;
            "
        >
            {% for p in recommended_products %}
            <div
                class="recommended-item"
                style="
                    background: var(--bg-header);
                    border-radius: var(--border-radius);
                    padding: 1.2rem;
                    border: 1px solid var(--border-color);
                    transition: var(--transition);
                    text-align: center;
                "
            >
                <a
                    href="{{ p.get_absolute_url }}"
                    style="
                        text-decoration: none;
                        color: inherit;
                        display: block;
                    "
                >
                    <div
                        style="
                            width: 120px;
                            height: 120px;
                            margin: 0 auto 1rem;
                            border-radius: 10px;
                            overflow: hidden;
                            border: 1px solid var(--border-light);
                        "
                    >
                        <img
                            src="{% if p.image %}{{ p.image.url }}{% else %}{% static 'shop/img/no_image.png' %}{% endif %}"
                            alt="{{ p.name }}"
                            style="
                                width: 100%;
                                height: 100%;
                                object-fit: cover;
                                transition: var(--transition);
                            "
                        />
                    </div>
                    <p
                        style="
                            font-weight: 500;
                            color: var(--text-primary);
                            margin: 0 0 0.5rem;
                            font-size: 0.95rem;
                            line-height: 1.3;
                            min-height: 2.6rem;
                        "
                    >
                        {{ p.name }}
                    </p>
                    <p style="color: var(--accent-primary); font-weight: 600; margin: 0.5rem 0; font-size: 1.1rem;">
                        {{ p.price|currency }}
                    </p>
                </a>
                <!-- –§–æ—Ä–º–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É -->
                <form
                    action="{% url 'cart:cart_add' p.id %}"
                    method="post"
                    class="add-to-cart-form"
                    style="margin: 0"
                >
                    {% csrf_token %}
                    <input type="hidden" name="quantity" value="1" />
                    <input type="hidden" name="override" value="False" />
                    <button
                        type="submit"
                        style="
                            background: var(--accent-primary);
                            color: var(--bg-dark);
                            border: none;
                            padding: 0.6rem 1.2rem;
                            border-radius: 6px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: var(--transition);
                            font-size: 0.9rem;
                            width: 100%;
                        "
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0, 212, 170, 0.3)';"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                    >
                        + {% translate "Add to cart" %}
                    </button>
                </form>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
    <div class="cart-actions">
        <a href="{% url 'shop:product_list' %}" class="button light">
            ‚Üê {% translate "Continue shopping" %}
        </a>
        <a href="{% url 'orders:order_create' %}" class="button">
            üêç {% translate "Checkout" %} ‚Üí
        </a>
    </div>
    {% else %}
    <div
        style="
            text-align: center;
            padding: 3rem;
            background: var(--bg-card);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        "
    >
        <h2 style="color: var(--text-secondary); margin-bottom: 1rem">
            {% translate "Your cart is empty" %}
        </h2>
        <p style="color: var(--text-secondary); margin-bottom: 2rem">
            {% translate "Discover our amazing collection of snakes!" %}
        </p>
        <a href="{% url 'shop:product_list' %}" class="button">
            {% translate "View catalog" %}
        </a>
    </div>
    {% endif %}
</div>

<style>
    .recommended-item:hover {
        transform: translateY(-5px);
        border-color: var(--accent-primary);
        box-shadow: var(--glow);
    }

    .recommended-item:hover img {
        transform: scale(1.05);
    }

    .add-to-cart-form button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 212, 170, 0.3);
    }

    @media (max-width: 768px) {
        .recommendations-grid {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .recommended-item {
            padding: 1rem;
        }
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É
        const addToCartForms = document.querySelectorAll(".add-to-cart-form");

        addToCartForms.forEach((form) => {
            form.addEventListener("submit", function (e) {
                e.preventDefault();

                const button = this.querySelector("button");
                const originalText = button.textContent;

                // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
                button.textContent = "‚úÖ {% translate 'Added!' %}";
                button.style.background = "#28a745";
                button.disabled = true;

                // –ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                setTimeout(() => {
                    this.submit();
                }, 800);
            });
        });

        // –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
        const recommendedItems = document.querySelectorAll(".recommended-item");
        recommendedItems.forEach((item) => {
            item.addEventListener("mouseenter", function () {
                this.style.transform = "translateY(-5px)";
                this.style.borderColor = "var(--accent-primary)";
                this.style.boxShadow = "var(--glow)";
                const img = this.querySelector("img");
                if (img) img.style.transform = "scale(1.05)";
            });

            item.addEventListener("mouseleave", function () {
                this.style.transform = "translateY(0)";
                this.style.borderColor = "var(--border-color)";
                this.style.boxShadow = "none";
                const img = this.querySelector("img");
                if (img) img.style.transform = "scale(1)";
            });
        });
    });
</script>
{% endblock %}